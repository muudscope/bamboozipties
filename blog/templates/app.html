{% extends "base.html" %}

{% block htmltitle %}
Blog CRUD
{% endblock %}

{% block content %}


<script type="text/javascript" src="http://reallysimplehistory.googlecode.com/svn/trunk/rsh.js"></script>
<script type="text/javascript" src="http://reallysimplehistory.googlecode.com/svn/trunk/json2007.js"></script>

<script>
    function load_table() {
        var url = '/blog/list.json';
        $.getJSON(url, null, function(data) {
          $.each(data, function(n, row) {
            $("#post_list_table tr:last").after(
              '<tr id="post-id'+row.pk+'"><td>'+row.fields.title+'</td><td>'
                +row.fields.name+'</td><td>'
                +row.fields.content+'</td><td>'
                +'<td><a href="#" onclick="return intrapage_navigate(\'show_entry_frame\');">Show</a> | '
                +'<a href="#" onclick="return delete_entry('+row.pk+');">Delete</a>'
                +'</td></tr>');
          });
        });
    }

    function delete_entry(id) {
      if( confirm("Delete Post?") ) {
        // They said yes

        var url = '/blog/delete/'+id+'.json';
        jQuery.post(url, function(data) {
            $("#post-id"+id).remove();
        });

      }
      return 0;
    }

    $(document).ready( load_table() 
    );

    function intrapage_navigate(frame) {
      //TODO: Get the name of the frame we're heading to by looking at the 
      // object that triggered the event, and pulling its href.
      // instead of passing in frame as a function parameter
      //jQuery('.uiframe').addClass('hidden');
      //jQuery('#'+frame).removeClass('hidden');
      console.log('nothing in intrapage_navigate');
    }



window.dhtmlHistory.create();

var yourListener = function(newLocation, historyData) {
    jQuery('.uiframe').addClass('hidden');
    jQuery('#'+newLocation).removeClass('hidden');
}

window.onload = function() {
        dhtmlHistory.initialize();
        dhtmlHistory.addListener(yourListener);
};

</script>


  <div id="post_list_frame" class="uiframe">
    <h2>All Blog Posts</h2>
    <table border=2 id="post_list_table">
    <tr>
      <th>Title</th>
      <th>Name</th>
      <th>Content</th>
      <td></td>
    </tr>

    </table>
    <a href="#new_entry_frame" onclick="intrapage_navigate('new_entry_frame')">New Post</a>
  </div>

  <div id="show_entry_frame" class="uiframe hidden">
    <h2> Show Post </h2>
    <p>
      <b>Title:</b>
      <span id="show_post_title"></span>
    </p>
    <p>
      <b>Name:</b>
      <span id="show_post_name"></span>
    </p>
    <p>
      <b>Content:</b>
      <span id="show_post_content"></span>
    </p>
    <a href="#edit_entry_frame" onclick="intrapage_navigate('edit_entry_frame')">Edit Post</a> |
    <a href="#post_list_frame" onclick="intrapage_navigate('post_list_frame')">List Posts</a>
  </div>

  <div id="new_entry_frame" class="uiframe hidden">
    <h2> New Post </h2>
    <form name="new_post" action="create.json" method="POST">
        <p>
          <label>Title:</label><br/>
          <input id="post_title" name="post.title" size="30" type="text" /> 
        </p>
        <p>
          <label>Name:</label><br/>
          <span id="show_post_name"></span>
          <input id="post_name" name="post.name" size="30" type="text" /> 
        </p>
        <p>
          <label>Content:</label><br/>
          <textarea cols="40" id="post_content" name="post.content" rows="20"></textarea> 

        <input id="new_post_submit" name="commit" type="submit" value="Create" /> 
        </p>
    </form>
    <script>
      $('form[name=new_post]').submit(function(){ 
        $.ajax({
          type: "POST",
          url: $(this).attr('action'), 
          data: $(this).serialize(), 
          error: function(XMLHttpRequest, textStatus, errorThrown) {
            console.log("Error:"+textStatus);
            console.log(XMLHttpRequest);
            console.log(errorThrown);
            $('#debugResults').html(XMLHttpRequest.responseText);
            alert('Error posting form: '+textStatus);
          },
          success: function(jsonData) {
            console.log(jsonData);
            alert('New post created');
            intrapage_navigate('show_entry_frame');
          }, 
          dataType: 'json'
        });
        return false;  // prevents the browser from posting the form itself.
      });

    </script>

    <a href="#post_list_frame" onclick="intrapage_navigate('post_list_frame')">List Posts</a>
  </div>


  <div id="debugResults">
  </div>

{% endblock %}
