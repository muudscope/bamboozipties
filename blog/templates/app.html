{% extends "base.html" %}

{% block htmltitle %}
Blog CRUD
{% endblock %}

{% block content %}


<script type="text/javascript" src="http://reallysimplehistory.googlecode.com/svn/trunk/rsh.js"></script>
<script type="text/javascript" src="http://reallysimplehistory.googlecode.com/svn/trunk/json2007.js"></script>

<script>
    // loads the list of all Post objects for display in the list frame.
    function load_table() {
        var url = '/blog/list.json';
        $.getJSON(url, null, function(data) {
          $.each(data, function(n, row) {
            $("#post_list_table tr:last").after(
              '<tr id="post-id'+row.pk+'"><td>'+row.fields.title+'</td><td>'
                +row.fields.name+'</td><td>'
                +row.fields.content+'</td><td>'
                +'<td><a href="#show/'+row.pk+'" >Show</a> | '
                +'<a href="#" onclick="return delete_entry('+row.pk+');">Delete</a>'
                +'</td></tr>');
          });
        });
    }

    function delete_entry(id) {
      if( confirm("Delete Post?") ) {
        // They said yes

        var url = '/blog/delete/'+id+'.json';
        console.log("calling "+url);
        $.ajax({
          type: "POST",
          url: url,
          error: function(XMLHttpRequest, textStatus, errorThrown) {
            console.log("Error:"+textStatus);
            console.log(XMLHttpRequest);
            console.log(errorThrown);
            $('#debugResults').html(XMLHttpRequest.responseText);
            alert('Error: '+textStatus);
          },
          success: function(data) {
            $("#post-id"+id).remove();
          }
        });

      }
      return false;
    }

    //TODO: Make this run whenever the list frame is displayed, not just on page load.
    $(document).ready( load_table() );


    ///////////////////////////////////
    // initialize RSH for navigation
    ///////////////////////////////////
    window.dhtmlHistory.create();

    function intrapage_navigate(newLocation) {
        window.location.hash = newLocation;
    }

    var frame_load_methods={};

    var navigationListener = function(newLocation, historyData) {
        var pathdata;
        var slashIndex = newLocation.indexOf('/');
        var framename = newLocation;
        if( slashIndex >= 0 ) {
          // take substring.
          pathdata = newLocation.substring(slashIndex);
          framename = newLocation.substring(0,slashIndex);
        }
        jQuery('.uiframe').addClass('hidden');
        jQuery('#'+framename).removeClass('hidden');

        //TODO: Build generalized switch statement here
        console.log("moving to frame:"+framename);
        console.log("path data is "+pathdata);
        if( frame_load_methods[framename] ) {
            console.log("calling frame_load_method for "+framename+" with "+pathdata);
            frame_load_methods[framename](pathdata);
        }
    };

    window.onload = function() {
        dhtmlHistory.initialize();
        dhtmlHistory.addListener(navigationListener);
    };

</script>


  <div id="post_list_frame" class="uiframe">
    <h2>All Blog Posts</h2>
    <table border=2 id="post_list_table">
    <tr>
      <th>Title</th>
      <th>Name</th>
      <th>Content</th>
      <td></td>
    </tr>

    </table>
    <a href="#new_entry_frame">New Post</a>
  </div>

  <div id="show" class="uiframe hidden">
    <h2> Show Post </h2>
    <p>
      <b>Title:</b>
      <span id="show_post_title"></span>
    </p>
    <p>
      <b>Name:</b>
      <span id="show_post_name"></span>
    </p>
    <p>
      <b>Content:</b>
      <span id="show_post_content"></span>
    </p>
    <a href="#edit_entry_frame" >Edit Post</a> |
    <a href="#post_list_frame" >List Posts</a>
    <script>
       frame_load_methods['show']=function(path) {
         id = path.substring(1);
         var url = '/blog/show/'+id+'.json';
         console.log("calling "+url);
         $.ajax({
           type: "GET",
           url: url,
           error: function(XMLHttpRequest, textStatus, errorThrown) {
             console.log("Error:"+textStatus);
             console.log(XMLHttpRequest);
             console.log(errorThrown);
             $('#debugResults').html(XMLHttpRequest.responseText);
             alert('Error: '+textStatus);
           },
           success: function(data) {
             console.log("show data returned "+data);
             obj = data[0];
             console.log(obj);
             console.log(obj.pk);
             $('#show_post_title').html(obj.fields.title);
             $('#show_post_name').html(data[0].fields.name);
             $('#show_post_content').html(data[0].fields.content);
           },
           dataType: 'json'
         });
       };
    </script>
  </div>

  <div id="new_entry_frame" class="uiframe hidden">
    <h2> New Post </h2>
    <form name="new_post" action="create.json" method="POST">
        <p>
          <label>Title:</label><br/>
          <input id="post_title" name="post.title" size="30" type="text" /> 
        </p>
        <p>
          <label>Name:</label><br/>
          <span id="show_post_name"></span>
          <input id="post_name" name="post.name" size="30" type="text" /> 
        </p>
        <p>
          <label>Content:</label><br/>
          <textarea cols="40" id="post_content" name="post.content" rows="20"></textarea> 

        <input id="new_post_submit" name="commit" type="submit" value="Create" /> 
        </p>
    </form>
    <script>
      $('form[name=new_post]').submit(function(){ 
        $.ajax({
          type: "POST",
          url: $(this).attr('action'), 
          data: $(this).serialize(), 
          error: function(XMLHttpRequest, textStatus, errorThrown) {
            console.log("Error:"+textStatus);
            console.log(XMLHttpRequest);
            console.log(errorThrown);
            $('#debugResults').html(XMLHttpRequest.responseText);
            alert('Error posting form: '+textStatus);
          },
          success: function(jsonData) {
            console.log(jsonData);
            alert('New post created');
            intrapage_navigate('show/'+jsonData[0].pk);
          }, 
          dataType: 'json'
        });
        return false;  // prevents the browser from posting the form itself.
      });

    </script>

    <a href="#post_list_frame" >List Posts</a>
  </div>


  <div id="debugResults">
  </div>

{% endblock %}
